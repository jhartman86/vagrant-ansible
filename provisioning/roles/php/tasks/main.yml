---
- name: Add PHP5 PPA repository
  apt_repository: repo={{ php_ppa }} state=present update_cache=yes

- name: Install PHP5
  apt: pkg=php5 state=present

- name: Install PHP5-cli
  apt: pkg=php5-cli state=present

- name: Install PHP packages
  apt: pkg={{ item }} state=present
  with_items: php_packages

- name: Configure Xdebug
  template: src=xdebug.ini.j2 dest=/etc/php5/mods-available/xdebug.ini owner=root group=root mode=0644

- name: Install Composer
  shell: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin creates=/usr/local/bin/composer

- name: Rename composer.phar to composer
  shell: mv /usr/local/bin/composer.phar /usr/local/bin/composer creates=/usr/local/bin/composer

- name: Make composer executable
  file: path=/usr/local/bin/composer mode=a+x state=file

- name: Install PHPUnit 4.5.0
  shell: >
    cd /usr/local/bin \
      && wget https://phar.phpunit.de/phpunit.phar \
      && mv phpunit.phar phpunit \
      && chmod +x phpunit
  sudo: yes
  args:
    creates: /usr/local/bin/phpunit

- name: Checkout phpredis build directory
  git:
    repo: https://github.com/phpredis/phpredis.git
    dest: /usr/local/src/phpredis
    version: 2.2.7
    update: no

- name: Build phpredis extension
  shell: cd /usr/local/src/phpredis && phpize && ./configure && make && make install
  sudo: yes
  args:
    chdir: /usr/local/src/phpredis
    creates: /usr/local/src/phpredis/build
  register: phpredis_result

- name: Add phpredis.ini
  template: src=redis.ini.j2 dest=/etc/php5/mods-available/redis.ini owner=root group=root mode=0644

- name: Enable phpredis module with php5enmod
  shell: php5enmod redis
  sudo: yes
  when: phpredis_result|changed

# PHP Configuration
- name: Enable short_open_tags in apache2 php.ini
  lineinfile: dest=/etc/php5/apache2/php.ini regexp="{{ item.regexp }}" line="{{ item.line }}" backup=yes
  with_items:
    - { regexp: "short_open_tag =", line: "short_open_tag = On" }
  notify: restart_apache

- name: Enable short_open_tags in cli php.ini
  lineinfile: dest=/etc/php5/cli/php.ini regexp="{{ item.regexp }}" line="{{ item.line }}" backup=yes
  with_items:
    - { regexp: "short_open_tag =", line: "short_open_tag = On" }

- name: Use redis for sessions
  lineinfile: dest=/etc/php5/apache2/php.ini regexp="{{ item.regexp }}" line="{{ item.line }}" backup=yes
  with_items:
    - { regexp: "session.save_handler =", line: "session.save_handler = redis" }
    - { regexp: ";session.save_path =", line: 'session.save_path = \"tcp://127.0.0.1:6379?weight=1\"' }
  notify: restart_apache